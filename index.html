<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Trip Report / IFTA Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1, h2 {
      margin: 0 0 12px 0;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    select {
      padding: 6px 10px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #334155;
      text-align: left;
    }

    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:hover {
      background: #020617;
    }

    .route {
      color: #38bdf8;
      font-weight: 600;
    }

    .number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .card {
      background: #020617;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 24px;
    }
  </style>
</head>
<body>

<h1>ðŸšš Daily Trip Report</h1>

<div class="controls">
  <select id="yearSelect"></select>
  <select id="quarterSelect">
    <option value="ALL">All Quarters</option>
    <option value="Q1">Q1 (Janâ€“Mar)</option>
    <option value="Q2">Q2 (Aprâ€“Jun)</option>
    <option value="Q3">Q3 (Julâ€“Sep)</option>
    <option value="Q4">Q4 (Octâ€“Dec)</option>
  </select>
</div>

<div class="card">
  <h2>IFTA Mileage Summary</h2>
  <table id="iftaTable">
    <thead>
      <tr>
        <th>State</th>
        <th class="number">Miles</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h2>Trips</h2>
  <table id="tripTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Origin</th>
        <th>Destination</th>
        <th>Route</th>
        <th class="number">Miles</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2mGE3YfbLHrHeVtSAW5sq7WdEGTbwGhefLtZbwAqcfT-6kZsQmIy2954KQm9yT1mg93EKLpjU8jPA/pub?output=csv";

let allTrips = [];

async function loadCSV() {
  const res = await fetch(CSV_URL);
  const text = await res.text();

  const rows = text
    .split("\n")
    .map(r =>
      r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
       .map(v => v.replace(/^"|"$/g, "").trim())
    )
    .filter(r => r.length && r.some(c => c));

  // ðŸ”‘ Find the REAL header row
  const headerIndex = rows.findIndex(r => r[0] === "Date");
  if (headerIndex === -1) {
    console.error("Header row not found");
    return;
  }

  const headers = rows[headerIndex];
  const dataRows = rows.slice(headerIndex + 1);

  allTrips = dataRows.map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = r[i] || "");
    return obj;
  });

  initFilters();
  render();
}

function initFilters() {
  const yearSelect = document.getElementById("yearSelect");

  const years = [...new Set(
    allTrips
      .map(t => new Date(t.Date))
      .filter(d => !isNaN(d))
      .map(d => d.getFullYear())
  )].sort();

  yearSelect.innerHTML =
    `<option value="ALL">All Years</option>` +
    years.map(y => `<option value="${y}">${y}</option>`).join("");

  yearSelect.onchange = render;
  document.getElementById("quarterSelect").onchange = render;
}

function getQuarter(date) {
  const m = date.getMonth() + 1;
  if (m <= 3) return "Q1";
  if (m <= 6) return "Q2";
  if (m <= 9) return "Q3";
  return "Q4";
}

function render() {
  const year = document.getElementById("yearSelect").value;
  const quarter = document.getElementById("quarterSelect").value;

  const filtered = allTrips.filter(t => {
    const d = new Date(t.Date);
    if (isNaN(d)) return false;
    if (year !== "ALL" && d.getFullYear().toString() !== year) return false;
    if (quarter !== "ALL" && getQuarter(d) !== quarter) return false;
    return true;
  });

  renderTrips(filtered);
  renderIFTA(filtered);
}

function renderTrips(trips) {
  const tbody = document.querySelector("#tripTable tbody");
  tbody.innerHTML = "";

  trips.forEach(t => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.Date}</td>
      <td>${t["Origin City/State"]}</td>
      <td>${t["Destination City/State"]}</td>
      <td class="route">${t.Route}</td>
      <td class="number">${Number(t.Mileage).toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderIFTA(trips) {
  const totals = {};

  trips.forEach(t => {
    if (!t.Route || !t.Mileage) return;

    const states = t.Route.split(",").map(s => s.trim());
    const miles = Number(t.Mileage);
    if (!states.length || isNaN(miles)) return;

    const per = miles / states.length;

    states.forEach(s => {
      totals[s] = (totals[s] || 0) + per;
    });
  });

  const tbody = document.querySelector("#iftaTable tbody");
  tbody.innerHTML = "";

  Object.entries(totals)
    .sort((a, b) => b[1] - a[1])
    .forEach(([state, miles]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${state}</td>
        <td class="number">${miles.toFixed(1)}</td>
      `;
      tbody.appendChild(tr);
    });
}

loadCSV();
</script>


</body>
</html>
